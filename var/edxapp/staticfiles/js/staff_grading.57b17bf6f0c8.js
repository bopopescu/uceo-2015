(function(){var ajax_url,backend,mock_backend,state_error,state_graded,state_grading,state_no_data;state_grading="grading",state_graded="graded",state_no_data="no_data",state_error="error",this.StaffGradingBackend=function(){function StaffGradingBackend(ajax_url,mock_backend){this.ajax_url=ajax_url,ajax_url||(mock_backend=!0),this.mock_backend=mock_backend,this.mock_backend&&(this.mock_cnt=0)}return StaffGradingBackend.prototype.mock=function(cmd,data){var response;if("get_next"===cmd)switch(this.mock_cnt++,data.location){case"i4x://MITx/3.091x/problem/open_ended_demo1":response={success:!0,problem_name:"Problem 1",num_graded:3,min_for_ml:5,num_pending:4,prompt:'<h2>S11E3: Metal Bands</h2>\n<p>Shown below are schematic band diagrams for two different metals. Both diagrams appear different, yet both of the elements are undisputably metallic in nature.</p>\n<img width="480" src="/static/images/LSQimages/shaded_metal_bands.png"/>\n<p>* Why is it that both sodium and magnesium behave as metals, even though the s-band of magnesium is filled? </p>\n<p>This is a self-assessed open response question. Please use as much space as you need in the box below to answer the question.</p>',submission:'Contrary to popular belief, Lorem Ipsum is not simply random text. It has roots in a piece of classical Latin literature from 45 BC, making it over 2000 years old. Richard McClintock, a Latin professor at Hampden-Sydney College in Virginia, looked up one of the more obscure Latin words, consectetur, from a Lorem Ipsum passage, and going through the cites of the word in classical literature, discovered the undoubtable source. Lorem Ipsum comes from sections 1.10.32 and 1.10.33 of "de Finibus Bonorum et Malorum" (The Extremes of Good and Evil) by Cicero, written in 45 BC. This book is a treatise on the theory of ethics, very popular during the Renaissance. The first line of Lorem Ipsum, "Lorem ipsum dolor sit amet..", comes from a line in section 1.10.32.\n\nThe standard chunk of Lorem Ipsum used since the 1500s is reproduced below for those interested. Sections 1.10.32 and 1.10.33 from "de Finibus Bonorum et Malorum" by Cicero are also reproduced in their exact original form, accompanied by English versions from the 1914 translation by H. Rackham.',rubric:'<table class="rubric"><tbody><tr><th>Purpose</th>\n\n            <td>\n                    <input type="radio" class="score-selection" name="score-selection-0" id="score-0-0" value="0"><label for="score-0-0">No product</label>\n            </td>\n\n            <td>\n                    <input type="radio" class="score-selection" name="score-selection-0" id="score-0-1" value="1"><label for="score-0-1">Unclear purpose or main idea</label>\n            </td>\n\n            <td>\n                    <input type="radio" class="score-selection" name="score-selection-0" id="score-0-2" value="2"><label for="score-0-2">Communicates an identifiable purpose and/or main idea for an audience</label>\n            </td>\n\n            <td>\n                    <input type="radio" class="score-selection" name="score-selection-0" id="score-0-3" value="3"><label for="score-0-3">Achieves a clear and distinct purpose for a targeted audience and communicates main ideas with effectively used techniques to introduce and represent ideas and insights</label>\n            </td>\n        </tr><tr><th>Organization</th>\n\n            <td>\n                    <input type="radio" class="score-selection" name="score-selection-1" id="score-1-0" value="0"><label for="score-1-0">No product</label>\n            </td>\n\n            <td>\n                    <input type="radio" class="score-selection" name="score-selection-1" id="score-1-1" value="1"><label for="score-1-1">Organization is unclear; introduction, body, and/or conclusion are underdeveloped, missing or confusing.</label>\n            </td>\n\n            <td>\n                    <input type="radio" class="score-selection" name="score-selection-1" id="score-1-2" value="2"><label for="score-1-2">Organization is occasionally unclear; introduction, body or conclusion may be underdeveloped.</label>\n            </td>\n\n            <td>\n                    <input type="radio" class="score-selection" name="score-selection-1" id="score-1-3" value="3"><label for="score-1-3">Organization is clear and easy to follow; introduction, body and conclusion are defined and aligned with purpose.</label>\n            </td>\n        </tr></tbody></table>',submission_id:this.mock_cnt,max_score:2+this.mock_cnt%3,ml_error_info:"ML accuracy info: "+this.mock_cnt};break;case"i4x://MITx/3.091x/problem/open_ended_demo2":response={success:!0,problem_name:"Problem 2",num_graded:2,min_for_ml:5,num_pending:4,prompt:"This is a fake second problem",submission:"This is the best submission ever! "+this.mock_cnt,rubric:"I am a rubric for grading things! "+this.mock_cnt,submission_id:this.mock_cnt,max_score:2+this.mock_cnt%3,ml_error_info:"ML accuracy info: "+this.mock_cnt};break;default:response={success:!1}}else"save_grade"===cmd?response=this.mock("get_next",{location:data.location}):"get_problem_list"===cmd?(this.mock_cnt=1,response={success:!0,problem_list:[{location:"i4x://MITx/3.091x/problem/open_ended_demo1",problem_name:"Problem 1",num_graded:3,num_pending:5,min_for_ml:10},{location:"i4x://MITx/3.091x/problem/open_ended_demo2",problem_name:"Problem 2",num_graded:1,num_pending:5,min_for_ml:10}]}):response={success:!1,error:"Unknown command "+cmd};return this.mock_cnt%5===0&&(response={success:!0,message:"No more submissions"}),this.mock_cnt%7===0&&(response={success:!1,error:"An error for testing"}),response},StaffGradingBackend.prototype.post=function(cmd,data,callback){return this.mock_backend?callback(this.mock(cmd,data)):$.post(this.ajax_url+cmd,data,callback).error(function(){return callback({success:!1,error:"Error occurred while performing javascript AJAX post."})})},StaffGradingBackend}(),this.StaffGrading=function(){function StaffGrading(backend){var _this=this;this.scroll_to_top=function(){return StaffGrading.prototype.scroll_to_top.apply(_this,arguments)},this.collapse_question=function(){return StaffGrading.prototype.collapse_question.apply(_this,arguments)},this.submit=function(){return StaffGrading.prototype.submit.apply(_this,arguments)},this.gentle_alert=function(){return StaffGrading.prototype.gentle_alert.apply(_this,arguments)},this.skip_and_get_next=function(){return StaffGrading.prototype.skip_and_get_next.apply(_this,arguments)},this.ajax_callback=function(){return StaffGrading.prototype.ajax_callback.apply(_this,arguments)},this.set_button_text=function(){return StaffGrading.prototype.set_button_text.apply(_this,arguments)},this.keyup_handler=function(){return StaffGrading.prototype.keyup_handler.apply(_this,arguments)},this.keydown_handler=function(){return StaffGrading.prototype.keydown_handler.apply(_this,arguments)},this.graded_callback=function(){return StaffGrading.prototype.graded_callback.apply(_this,arguments)},this.setup_score_selection=function(){return StaffGrading.prototype.setup_score_selection.apply(_this,arguments)},AjaxPrefix.addAjaxPrefix(jQuery,function(){return""}),this.backend=backend,this.el=$(".staff-grading"),this.problem_list_container=$(".problem-list-container"),this.problem_list=$(".problem-list"),this.error_container=$(".error-container"),this.message_container=$(".message-container"),this.prompt_name_container=$(".prompt-name"),this.prompt_container=$(".prompt-container"),this.prompt_wrapper=$(".prompt-wrapper"),this.submission_container=$(".submission-container"),this.submission_wrapper=$(".submission-wrapper"),this.grading_wrapper=$(".grading-wrapper"),this.feedback_area=$(".feedback-area"),this.score_selection_container=$(".score-selection-container"),this.grade_selection_container=$(".grade-selection-container"),this.flag_submission_checkbox=$(".flag-checkbox"),this.submit_button=$(".submit-button"),this.action_button=$(".action-button"),this.skip_button=$(".skip-button"),this.problem_meta_info=$(".problem-meta-info-container"),this.meta_info_wrapper=$(".meta-info-wrapper"),this.ml_error_info_container=$(".ml-error-info-container"),this.breadcrumbs=$(".breadcrumbs"),$(window).keydown(this.keydown_handler),$(window).keyup(this.keyup_handler),this.question_header=$(".question-header"),this.question_header.click(this.collapse_question),this.collapse_question(),this.state=state_no_data,this.submission_id=null,this.prompt="",this.submission="",this.rubric="",this.error_msg="",this.message="",this.max_score=0,this.ml_error_info="",this.location="",this.prompt_name="",this.min_for_ml=0,this.num_graded=0,this.num_pending=0,this.score_lst=[],this.grade=null,this.is_ctrl=!1,this.problems=null,this.submit_button.click(this.submit),this.action_button.click(this.submit),this.skip_button.click(this.skip_and_get_next),this.get_problem_list()}return StaffGrading.prototype.grading_message_sel=".grading-message",StaffGrading.prototype.setup_score_selection=function(){var _this=this;return this.score_selection_container.html(this.rubric),$('input[class="score-selection"]').change(function(){return _this.graded_callback()}),this.rub=new Rubric(this.el),this.rub.initialize(this.location)},StaffGrading.prototype.graded_callback=function(){return this.rub.check_complete()?(this.state=state_graded,this.submit_button.show()):void 0},StaffGrading.prototype.keydown_handler=function(event){return 17===event.which&&this.is_ctrl===!1?this.is_ctrl=!0:this.is_ctrl===!0&&13===event.which&&!this.list_view&&this.rub.check_complete()?this.submit_and_get_next():void 0},StaffGrading.prototype.keyup_handler=function(event){return 17===event.which&&this.is_ctrl===!0?this.is_ctrl=!1:void 0},StaffGrading.prototype.set_button_text=function(text){return this.action_button.attr("value",text)},StaffGrading.prototype.ajax_callback=function(response){return this.error_msg="",this.message="",response.success?response.problem_list?this.problems=response.problem_list:response.submission?this.data_loaded(response):this.no_more(response.message):this.error(response.error),this.render_view(),this.scroll_to_top()},StaffGrading.prototype.get_next_submission=function(location){return this.location=location,this.list_view=!1,this.backend.post("get_next",{location:location},this.ajax_callback)},StaffGrading.prototype.skip_and_get_next=function(){var data;return data={score:this.rub.get_total_score(),rubric_scores:this.rub.get_score_list(),feedback:this.feedback_area.val(),submission_id:this.submission_id,location:this.location,skipped:!0,submission_flagged:!1},this.gentle_alert("Skipped the submission."),this.backend.post("save_grade",data,this.ajax_callback)},StaffGrading.prototype.get_problem_list=function(){return this.list_view=!0,this.render_view(!0),this.backend.post("get_problem_list",{},this.ajax_callback)},StaffGrading.prototype.submit_and_get_next=function(){var data;return data={score:this.rub.get_total_score(),rubric_scores:this.rub.get_score_list(),feedback:this.feedback_area.val(),submission_id:this.submission_id,location:this.location,submission_flagged:this.flag_submission_checkbox.is(":checked")},this.gentle_alert(gettext("Grades saved.  Fetching the next submission to grade.")),this.backend.post("save_grade",data,this.ajax_callback)},StaffGrading.prototype.gentle_alert=function(msg){return this.grading_message=$(this.grading_message_sel),this.grading_message.html(""),this.grading_message.fadeIn(),this.grading_message.html("<p>"+msg+"</p>")},StaffGrading.prototype.error=function(msg){return this.error_msg=msg,this.state=state_error},StaffGrading.prototype.data_loaded=function(response){return this.prompt=response.prompt,this.submission=response.submission,this.rubric=response.rubric,this.submission_id=response.submission_id,this.feedback_area.val(""),this.grade=null,this.max_score=response.max_score,this.ml_error_info=response.ml_error_info,this.prompt_name=response.problem_name,this.num_graded=response.num_graded,this.min_for_ml=response.min_for_ml,this.num_pending=response.num_pending,this.state=state_grading,null==this.max_score?this.error("No max score specified for submission."):void 0},StaffGrading.prototype.no_more=function(message){return this.prompt=null,this.prompt_name="",this.num_graded=0,this.min_for_ml=0,this.submission=null,this.rubric=null,this.ml_error_info=null,this.submission_id=null,this.message=message,this.grade=null,this.max_score=0,this.state=state_no_data},StaffGrading.prototype.render_view=function(before_ajax){var show_grading_elements;return this.problem_list.html("<tr>\n    <th>"+gettext("Problem Name")+"</th>\n<th>"+gettext("Graded")+"</th>\n<th>"+gettext("Available to Grade")+"</th>\n<th>"+gettext("Required")+"</th>\n<th>"+gettext("Progress")+"</th>\n</tr>"),this.breadcrumbs.html(""),this.problem_list_container.toggle(this.list_view),this.backend.mock_backend&&(this.message=this.message+"<p>NOTE: Mocking backend.</p>"),this.message_container.html(this.message),this.error_container.html(this.error_msg),this.message_container.toggle(""!==this.message),this.error_container.toggle(""!==this.error_msg),this.flag_submission_checkbox.prop("checked",!1),show_grading_elements=!(this.list_view||this.state===state_error||this.state===state_no_data),this.prompt_wrapper.toggle(show_grading_elements),this.submission_wrapper.toggle(show_grading_elements),this.grading_wrapper.toggle(show_grading_elements),this.meta_info_wrapper.toggle(show_grading_elements),this.action_button.hide(),before_ajax?this.scroll_to_top():this.list_view?this.render_list():this.render_problem()},StaffGrading.prototype.problem_link=function(problem){var link,_this=this;return link=$("<a>").attr("href","javascript:void(0)").append(""+problem.problem_name).click(function(){return _this.get_next_submission(problem.location)})},StaffGrading.prototype.make_paragraphs=function(text){var new_text,paragraph,paragraph_split,_i,_len;for(paragraph_split=text.split(/\n\s*\n/),new_text="",_i=0,_len=paragraph_split.length;_len>_i;_i++)paragraph=paragraph_split[_i],new_text+="<p>"+paragraph+"</p>";return new_text},StaffGrading.prototype.render_list=function(){var problem,problem_row,progress_max,progress_value,row_progress_bar,_i,_len,_ref,_results;for(_ref=this.problems,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)problem=_ref[_i],problem_row=$("<tr>"),problem_row.append($('<td class="problem-name">').append(this.problem_link(problem))),problem_row.append($("<td>").append(""+problem.num_graded)),problem_row.append($("<td>").append(""+problem.num_pending)),problem_row.append($("<td>").append(""+problem.num_required)),row_progress_bar=$("<div>").addClass("progress-bar"),progress_value=parseInt(problem.num_graded),progress_max=parseInt(problem.num_required)+progress_value,row_progress_bar.progressbar({value:progress_value,max:progress_max}),problem_row.append($("<td>").append(row_progress_bar)),_results.push(this.problem_list.append(problem_row));return _results},StaffGrading.prototype.render_problem=function(){var available,graded,meta_list,needed,problem_list_link,show_action_button,show_submit_button,_this=this;return show_submit_button=!0,show_action_button=!0,problem_list_link=$("<a>").attr("href","javascript:void(0);").append("< "+gettext("Back to problem list")).click(function(){return _this.get_problem_list()}),this.breadcrumbs.append(problem_list_link),this.state===state_error?(this.set_button_text(gettext("Try loading again")),show_action_button=!0):this.state===state_grading?(this.ml_error_info_container.html(this.ml_error_info),available=_.template(gettext("<%= num %> available "),{num:this.num_pending}),graded=_.template(gettext("<%= num %> graded "),{num:this.num_graded}),needed=_.template(gettext("<%= num %> more needed to start ML"),{num:Math.max(this.min_for_ml-this.num_graded,0)}),meta_list=$("<div>").append("<div class='meta-info'>"+available+"</div>").append("<div class='meta-info'>"+graded+"</div>").append("<div class='meta-info'>"+needed+"</div>"),this.problem_meta_info.html(meta_list),this.prompt_container.html(this.prompt),this.prompt_name_container.html(""+this.prompt_name),this.submission_container.html(this.make_paragraphs(this.submission)),show_submit_button=!1,show_action_button=!1,this.setup_score_selection()):this.state===state_graded?(this.set_button_text(gettext("Submit")),show_action_button=!1):this.state===state_no_data?(this.message_container.html(this.message),this.set_button_text(gettext("Re-check for submissions"))):this.error(_.template(gettext("System got into invalid state: <%= state %>"),{state:this.state})),this.submit_button.toggle(show_submit_button),this.action_button.toggle(show_action_button)},StaffGrading.prototype.submit=function(event){return event.preventDefault(),this.state===state_error?this.get_next_submission(this.location):this.state===state_graded?this.submit_and_get_next():this.state===state_no_data?this.get_next_submission(this.location):this.error(gettext("System got into invalid state for submission: ")+this.state)},StaffGrading.prototype.collapse_question=function(){var new_text;return this.prompt_container.slideToggle(),this.prompt_container.toggleClass("open"),this.question_header.text()===gettext("(Hide)")?(Logger.log("staff_grading_hide_question",{location:this.location}),new_text=gettext("(Show)")):(Logger.log("staff_grading_show_question",{location:this.location}),new_text=gettext("(Hide)")),this.question_header.text(new_text)},StaffGrading.prototype.scroll_to_top=function(){try{return $("html, body").animate({scrollTop:$(".staff-grading").offset().top},200)}catch(error){return console.log("Scrolling error.")}},StaffGrading}(),mock_backend=!1,ajax_url=$(".staff-grading").data("ajax_url"),backend=new StaffGradingBackend(ajax_url,mock_backend),$(document).ready(function(){return new StaffGrading(backend)})}).call(this);