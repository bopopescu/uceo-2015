<%namespace name='static' file='../static_content.html'/>
<%!
from microsite_configuration import microsite
from django.utils.translation import ugettext as _
from django.core.urlresolvers import reverse
from courseware.courses import course_image_url, get_course_about_section
from django.conf import settings
from edxmako.shortcuts import marketing_link
%>

<%inherit file="../main.html" />
<%namespace file='../main.html' import="login_query, stanford_theme_enabled"/>
<%block name="headextra">

  <%
    if self.theme_enabled():
      google_analytics_file = u'../{ga}'.format(
        ga=microsite.get_value('google_analytics_file', 'theme-google-analytics.html')
      )
    else:
      google_analytics_file = '../google_analytics.html'
  %>

  <%include file="${google_analytics_file}" />

  <script>
    function thirdPartySignin(event, url) {
      event.preventDefault();
      window.location.href = url;
    }
  </script>

  ## OG (Open Graph) title and description added below to give social media info to display
  ## (https://developers.facebook.com/docs/opengraph/howtos/maximizing-distribution-media-content#tags)
  <meta property="og:title" content="${get_course_about_section(course, 'title')}" />
  <meta property="og:description" content="${get_course_about_section(course, 'short_description')}" />
</%block>

## TODO: this should probably be an overrideable block,
##       or something allowing themes to do whatever they
##       want here (and on this whole page, really).
<%
  site_domain = microsite.get_value('site_domain', settings.SITE_NAME)
  platform_name = microsite.get_value('platform_name', settings.PLATFORM_NAME)

  # Translators: This text will be automatically posted to the student's
  # Twitter account. {url} should appear at the end of the text.
  tweet_text = _("I just registered for {number} {title} through {account}: {url}").format(
      number=course.number,
      title=get_course_about_section(course, 'title'),
      account=microsite.get_value('course_about_twitter_account', settings.PLATFORM_TWITTER_ACCOUNT),
      url=u"http://{domain}{path}".format(
          domain=site_domain,
          path=reverse('about_course', args=[course.id.to_deprecated_string()])
      )
  ).replace(u" ", u"+")
  tweet_action = u"http://twitter.com/intent/tweet?text={tweet_text}".format(tweet_text=tweet_text)

  facebook_link = microsite.get_value('course_about_facebook_link', settings.PLATFORM_FACEBOOK_ACCOUNT)

  email_subject = u"mailto:?subject={subject}&body={body}".format(
      subject=_("Take a course with {platform} online").format(platform=platform_name),
      body=_("I just registered for {number} {title} through {platform} {url}").format(
          number=course.number,
          title=get_course_about_section(course, 'title'),
          platform=platform_name,
          url=u"http://{domain}{path}".format(
              domain=site_domain,
              path=reverse('about_course', args=[course.id.to_deprecated_string()]),
          )
      )
  ).replace(u" ", u"%20")
%>

<%block name="js_extra">

  <script type="text/javascript">
  (function() {
    $(".register").click(function(event) {
      $("#class_enroll_form").submit();
      event.preventDefault();
    });

    % if is_shopping_cart_enabled:
      add_course_complete_handler = function(jqXHR, textStatus) {
        if (jqXHR.status == 200) {
          location.href = "${cart_link}";
        }
        if (jqXHR.status == 400) {
          $("#register_error")
            .html(jqXHR.responseText ? jqXHR.responseText : "${_("An error occurred. Please try again later.")}")
            .css("display", "block");
        }
        else if (jqXHR.status == 403) {
            location.href = "${reg_then_add_to_cart_link}";
        }
      };
      $("#add_to_cart_post").click(function(event){
        $.ajax({
          url: "${reverse('add_course_to_cart', args=[course.id.to_deprecated_string()])}",
          type: "POST",
          /* Rant: HAD TO USE COMPLETE B/C PROMISE.DONE FOR SOME REASON DOES NOT WORK ON THIS PAGE. */
          complete: add_course_complete_handler
        })
        event.preventDefault();
      });
    % endif

    ## making the conditional around this entire JS block for sanity
    %if settings.FEATURES.get('RESTRICT_ENROLL_BY_REG_METHOD') and course.enrollment_domain:
      <%
        perms_error = _('The currently logged-in user account does not have permission to enroll in this course. '
                        'You may need to {start_logout_tag}log out{end_tag} then try the register button again. '
                        'Please visit the {start_help_tag}help page{end_tag} for a possible solution.').format(
                          start_help_tag="<a href='{url}'>".format(url=marketing_link('FAQ')), end_tag='</a>',
                          start_logout_tag="<a href='{url}'>".format(url=reverse('logout'))
                          )
      %>
    $('#class_enroll_form').on('ajax:complete', function(event, xhr) {
      if(xhr.status == 200) {
        location.href = "${reverse('dashboard')}";
      } else if (xhr.status == 403) {
        location.href = "${reverse('course-specific-register', args=[course.id.to_deprecated_string()])}?course_id=${course.id | u}&enrollment_action=enroll";
      } else if (xhr.status == 400) { //This means the user did not have permission
        $('#register_error').html("${perms_error}").css("display", "block");
      } else {
        $('#register_error').html(
            (xhr.responseText ? xhr.responseText : "${_("An error occurred. Please try again later.")}")
        ).css("display", "block");
      }
    });

    %else:

    $('#class_enroll_form').on('ajax:complete', function(event, xhr) {
      if(xhr.status == 200) {
        if (xhr.responseText == "") {
          location.href = "${reverse('dashboard')}";
        }
        else {
          location.href = xhr.responseText;
        }
      } else if (xhr.status == 403) {
          location.href = "${reverse('register_user')}?course_id=${course.id | u}&enrollment_action=enroll";
      } else {
        $('#register_error').html(
            (xhr.responseText ? xhr.responseText : "${_("An error occurred. Please try again later.")}")
        ).css("display", "block");
      }
    });

    %endif

    var read_more = $('.read-more')[0];
    console.log(read_more);

    if (read_more != null) {
      var about_height = $('.about')[0].scrollHeight+50;
      var responses_height = $('.responses')[0].scrollHeight+50;

      $('.about').css("height", "250px");
      $('.responses').css("height", "250px");
      $('#more-about').click(function(e) {
          e.stopPropagation();
          e.preventDefault();
          $('.about').animate({
              'height': about_height
          })
      });

      $('#more-responses').click(function(e) {
          e.stopPropagation();
          e.preventDefault();
          $('.responses').animate({
              'height': responses_height
          })
      });

      $(document).click(function() {
          $('.about').animate({
              'height': '250px'
          });

          $('.responses').animate({
              'height': '250px'
          });
      })
    }

    

  })(this)
  </script>

  <script src="${static.url('js/course_info.js')}"></script>
</%block>

<%block name="pagetitle">${get_course_about_section(course, "title")}</%block>

<section class="course-info">
  <header class="course-profile">
    <div class="image-overlay"></div>
    <div class="intro-inner-wrapper">
      <div class="table">
        % if get_course_about_section(course, "video"):
        <a href="#video-modal" class="media" rel="leanModal">
          <div class="hero">
            <img src="${course_image_url(course)}" alt="" />
            <div class="play-intro"></div>
          </div>
        </a>
        %else:
        <div class="media">
          <div class="hero">
            <img src="${course_image_url(course)}" alt="" />
          </div>
        </div>
        % endif
        <section class="intro">
          <hgroup>
            <h1>${get_course_about_section(course, "title")}</h1>
            <h2>${get_course_about_section(course, "short_description")}</h2>
          </hgroup>

          <div class="main-cta">
          %if user.is_authenticated() and registered:
            %if show_courseware_link:
              <a href="${course_target}">
            %endif

            <span class="register disabled">${_("You are registered for this course")}</span>

            %if show_courseware_link:
              <strong>${_("View Courseware")}</strong>
              </a>
            %endif

          % elif invitation_only and not can_enroll:
            <span class="register disabled">${_("Enrollment in this course is by invitation only")}</span>
          ## Shib courses need the enrollment button to be displayed even when can_enroll is False,
          ## because AnonymousUsers cause can_enroll for shib courses to be False, but we need them to be able to click
          ## so that they can register and become a real user that can enroll.
          % elif not is_shib_course and not can_enroll:
            <span class="register disabled">${_("Enrollment is Closed")}</span>
          % elif user.is_authenticated():
            <span class="course-start-date"><p><i class="icon fa fa-calendar"></i>&nbsp; ${course.start_datetime_text()}</p></span>
            <div class="social-sharing">
              <div class="sharing-message">${_("Share with friends and family!")}</div>
              <div class="sharing-icon">
                <a href="${tweet_action}" class="share">
                  <i class="icon fa fa-twitter"></i><span class="sr">${_("Tweet that you've registered for this course")}</span>
                </a>
                <a href="${facebook_link}" class="share">
                  <i class="icon fa fa-thumbs-up"></i><span class="sr">${_("Post a Facebook message to say you've registered for this course")}</span>
                </a>
                <a href="${email_subject}" class="share">
                  <i class="icon fa fa-envelope"></i><span class="sr">${_("Email someone to say you've registered for this course")}</span>
                </a>
              </div>
            </div>
            <a href="#" class="register">
              ${_("Enroll for {course.display_number_with_default}").format(course=course) | h}
            </a>
            <div id="register_error"></div>
          %else:
            <span class="course-start-date"><p><i class="icon fa fa-calendar"></i>&nbsp; ${course.start_datetime_text()}</p></span>
            <div class="social-sharing">
              <div class="sharing-message">${_("Share with friends and family!")}</div>
              <div class="sharing-icon">
              <a href="${tweet_action}" class="share">
                <i class="icon fa fa-twitter"></i><span class="sr">${_("Tweet that you've registered for this course")}</span>
              </a>
              <a href="${facebook_link}" class="share">
                <i class="icon fa fa-thumbs-up"></i><span class="sr">${_("Post a Facebook message to say you've registered for this course")}</span>
              </a>
              <a href="${email_subject}" class="share">
                <i class="icon fa fa-envelope"></i><span class="sr">${_("Email someone to say you've registered for this course")}</span>
              </a>
              </div>
            </div>
            <a href="#" class="register">
              ${_("Register for {course.display_number_with_default}").format(course=course) | h}
            </a>
            <div id="register_error"></div>
          %endif
          </div>

        </section>
      
      </div>
      </div>
  </header>

  <section class="container">
    <section class="details">
      % if staff_access and studio_url is not None:
        <div class="wrap-instructor-info studio-view">
          <a class="instructor-info-action" href="${studio_url}">${_("View About Page in studio")}</a>
        </div>
      % endif

      <div class="inner-wrapper">
        ${get_course_about_section(course, "overview")}
      </div>
    </section>

    <section class="course-sidebar">
      <section class="course-summary">

        <ol class="important-dates">
          <li class="important-dates-item"><i class="icon fa fa-info-sign"></i><p class="important-dates-item-title">${_("Course Number")}</p><span class="important-dates-item-text course-number">${course.display_number_with_default | h}</span></li>
          % if not course.start_date_is_still_default:
            <li class="important-dates-item"><i class="icon fa fa-calendar"></i><p class="important-dates-item-title">${_("Classes Start")}</p><span class="important-dates-item-text start-date">${course.start_datetime_text()}</span></li>
          % endif
            ## We plan to ditch end_date (which is not stored in course metadata),
            ## but for backwards compatibility, show about/end_date blob if it exists.
            % if get_course_about_section(course, "end_date") or course.end:
            <li class="important-dates-item">
                <i class="icon fa fa-calendar"></i>
                <p class="important-dates-item-title">${_("Classes End")}</p>
                <span class="important-dates-item-text final-date">
                    % if get_course_about_section(course, "end_date"):
                        ${get_course_about_section(course, "end_date")}
                    % else:
                        ${course.end_datetime_text()}
                    % endif
                </span>
            </li>
            % endif

          % if get_course_about_section(course, "effort"):
            <li class="important-dates-item"><i class="icon fa fa-pencil"></i><p class="important-dates-item-title">${_("Estimated Effort")}</p><span class="important-dates-item-text effort">${get_course_about_section(course, "effort")}</span></li>
          % endif

          ##<li class="important-dates-item"><i class="icon fa fa-clock-o"></i><p class="important-dates-item-title">${_('Course Length')}</p><span class="important-dates-item-text course-length">${_('{number} weeks').format(number=15)}</span></li>
          % if not user.is_authenticated():
          <li>
            <div class="cta cta-login">
              <h3 class="title">${_("Already registered?")}</h3>
              <p class="instructions">
                <button type="submit" class="button button-primary" onclick="window.location.assign('${reverse('signin_user')}${login_query()}')">Masuk UCEO</button>
                <button type="submit" class="button button-primary fb-button" onclick="thirdPartySignin(event, '/auth/login/facebook/?auth_entry=signin');">Masuk dengan Facebook</button>
                <button type="submit" class="button button-primary google-button" onclick="thirdPartySignin(event, '/auth/login/google-oauth2/?auth_entry=signin');">Masuk dengan Google</button>
              </p>
            </div>
          </li>
          % endif
          <li>
            <div class="cta cta-welcome">
              <h3>${_("Welcome to {platform_name}").format(platform_name=platform_name)}</h3>
              <p>${_("Registering with {platform_name} gives you access to all of our current and future free courses. Not ready to take a course just yet? Registering puts you on our mailing list - we will update you as courses are added.").format(platform_name=platform_name)}</p>
            </div>
          </li>
          <li>
            <div class="cta cta-nextsteps">
              <h3>${_("Next Steps")}</h3>
              <p>${_("As part of joining {platform_name}, you will receive an activation email.  You must click on the activation link to complete the process.  Don't see the email?  Check your spam folder and mark {platform_name} emails as 'not spam'.  At {platform_name}, we communicate mostly through email.").format(platform_name=platform_name)}</p>
            </div>
          </li>
          <li>
            <div class="cta cta-help">
              <h3>${_("Need Help?")}</h3>
              <p>${_("Need help in registering with {platform_name}?").format(platform_name=platform_name)}
                <a href="${marketing_link('FAQ')}">
                    ${_("View our FAQs for answers to commonly asked questions.")}
                </a>
                ${_("Once registered, most questions can be answered in the course specific discussion forums or through the FAQs.")}</p>
            </div>
          </li>

          % if pre_requisite_courses:
          <li class="prerequisite-course important-dates-item">
            <i class="icon fa fa-list-ul"></i>
            <p class="important-dates-item-title">${_("Prerequisites")}</p>
            ## Multiple pre-requisite courses are not supported on frontend that's why we are pulling first element
            <span class="important-dates-item-text pre-requisite">${pre_requisite_courses[0]}</span>
            <p class="tip">${_("You must successfully complete {course} before you begin this course").format(course=pre_requisite_courses[0])}.</p>
          </li>
          % endif
          % if get_course_about_section(course, "prerequisites"):
            <li class="important-dates-item"><i class="icon fa fa-book"></i><p class="important-dates-item-title">${_("Requirements")}</p><span class="important-dates-item-text prerequisites">${get_course_about_section(course, "prerequisites")}</span></li>
          % endif
        </ol>
      </section>


      ## For now, ocw links are the only thing that goes in additional resources
      % if get_course_about_section(course, "ocw_links"):
      <section class="additional-resources">
        <header>
          <h1>${_("Additional Resources")}</h1>
        </header>

        <section>
          ## "MITOpenCourseware" should *not* be translated
          <h2 class="opencourseware">MITOpenCourseware</h2>
             ${get_course_about_section(course, "ocw_links")}
        </section>
      </section>
      %endif
    </section>

  </section>
</section>

## Need to put this hidden form on the page so that the registration button works.
## Since it's no harm to display a hidden form, we display it with the most permissive conditional
## which is when the student is not registered.
%if active_reg_button or is_shib_course:
  <div style="display: none;">
    <form id="class_enroll_form" method="post" data-remote="true" action="${reverse('change_enrollment')}">
      <fieldset class="enroll_fieldset">
        <input name="course_id" type="hidden" value="${course.id | h}">
        <input name="enrollment_action" type="hidden" value="enroll">
      </fieldset>
      <div class="submit">
        <input name="submit" type="submit" value="enroll">
      </div>
    </form>
  </div>
%endif

<%include file="../video_modal.html" />
